<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="mybatis.ChatMapper">

	<insert id = "createRoom">
	insert into CHATROOM (genid , pid, CLASS_class_id) 
	values(#{genid}, #{pid} , #{CLASS_class_id} )	
	</insert>
	
	
	<select id ="isRoom" resultType = "ChatRoomVO">	
	select * from CHATROOM WHERE genid = #{genid} and pid = #{pid} 
	and CLASS_class_id = #{CLASS_class_id} 
	</select>
	
	<insert id = "insertMessage">
	insert into MESSAGE (message_sender , message_receiver, message_content, 
	CHATROOM_chatroom_id, genid , pid, CLASS_class_id)
	values (#{message_sender}, #{message_receiver}, #{message_content} , #{CHATROOM_chatroom_id} , #{genid},
	#{pid} , #{CLASS_class_id})
	</insert>
	
	<select id = "getPartner" resultType = "MessageVO">
	SELECT genid from MESSAGE where pid = #{pid} and CLASS_class_id = #{CLASS_class_id}
	</select>
	
	<select id = "getName" resultType = "String">
		select genname from USER where genid = #{genid}
	</select>
	
	<select id = "getMessageList" resultType = "MessageVO">
	select * from MESSAGE where CHATROOM_chatroom_id = #{CHATROOM_chatroom_id}
	</select>
	
	<select id = "getRoomList" resultType = "ChatRoomVO">
	select * from CHATROOM where genid = #{genid}
	</select>
	
	<select id = "getRoomList2" resultType = "ChatRoomVO">
	select * from CHATROOM where pid = #{pid}
	</select>
	
	<select id = "getRecentMessage" resultType = "MessageVO">
	select m.* , class_name, class_id , pid from MESSAGE m left outer join CLASS c on m.CLASS_class_id = c.class_id 
	where CHATROOM_chatroom_id = #{CHATROOM_chatroom_id} order by message_id desc limit 1;
	</select>
	
	
	<select id = "getTutorId" resultType = "String">
	select pid from TUTOR where genid = #{genid}
	</select>
	
	<update id ="updateReadTime">
	update MESSAGE set message_readTime = NOW() where pid = #{pid} AND CLASS_class_id = #{CLASS_class_id} AND message_readTime = message_sendTime and message_sender = pid and genid = #{genid};
	</update>
	
	<update id ="updateReadTimeTutor">
	update MESSAGE set message_readTime = NOW() where pid = #{pid} AND CLASS_class_id = #{CLASS_class_id} AND message_readTime = message_sendTime and message_sender = genid and genid = #{genid};
	
	</update>
	
	
	<select id = "getUnReadCount" resultType = "int">
	
	select count(*) from MESSAGE where USER_user_id = #{USER_user_id} and TUTOR_USER_user_id = #{TUTOR_USER_user_id} AND CLASS_class_id = #{CLASS_class_id} AND message_readTime = message_sendTime and message_sender = TUTOR_USER_user_id;
	
	</select>
	<select id = "getUnReadCountTutor" resultType = "int">
	
	select count(*) from MESSAGE where pid =#{pid} and CLASS_class_id = #{CLASS_class_id} AND message_readTime = message_sendTime and message_sender = genid and genid = #{genid};
	
	</select>
	
	<select id = "getAllCount" resultType = "int">
	select count(*) from MESSAGE WHERE (pid = #{pid} and message_readTime = message_sendTime and message_sender != #{genid}) or (genid = #{genid} and message_readTime = message_sendTime and message_sender != #{genid}); 
	
	</select>
</mapper>